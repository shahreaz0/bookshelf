!function(e){var t={};function o(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(r,i,function(t){return e[t]}.bind(null,i));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=9)}([function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("path")},function(e,t,o){const r=o(1),i=o(20),a=r.Schema({username:{type:String,maxlength:20,unique:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://image.flaticon.com/icons/svg/758/758669.svg"},posts:[{type:r.Schema.Types.ObjectId,ref:"Book"}]},{timestamps:!0});a.plugin(i),e.exports=r.model("User",a)},function(e,t,o){const r=o(7),i=o(8);t.isLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return o();e.flash("error","You are not logged in"),t.redirect("/login")},t.ifLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return t.redirect("/books");o()},t.isBookOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await r.findById(e.params.id)).creator.equals(e.user._id))return o();e.flash("error","You can't edit other's post."),t.redirect("/books/"+e.params.id)},t.isCommentOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await i.findById(e.params.comment_id)).author===e.user.username)return o();e.flash("error","Permission denied"),t.redirect("back")}},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("dotenv")},function(e,t,o){const r=o(1),i=o(2),a=r.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImageName:{type:String,required:!0},pdfFileName:{type:String,required:!0},pageNo:{type:Number,min:1},language:{type:String},publishDate:{type:Date,default:new Date},status:{type:String,default:"public",enum:["public","private"]},comments:[{type:r.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:r.Schema.Types.ObjectId,ref:"User"}});a.virtual("coverImageUrl").get((function(){if(this.coverImageName)return"\\"+i.join("uploads","img","resized",this.coverImageName)})),a.virtual("pdfFileUrl").get((function(){if(this.pdfFileName)return"\\"+i.join("uploads","pdf",this.pdfFileName)})),e.exports=r.model("Book",a)},function(e,t,o){const r=o(1),i=r.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});e.exports=r.model("Comment",i)},function(e,t,o){e.exports=o(10)},function(e,t,o){const r=o(2),i=o(0),a=o(1),s=o(11),n=o(12),c=o(13),l=o(14)(c),u=o(5),d=o(15),p=o(16);o(6).config();const g=o(17),m=o(23),f=o(24),y=o(25),h=o(26);o(29),o(30);const b=i();b.set("views",r.join("views")),b.set("view engine","ejs"),b.use(i.static(r.join("public"))),b.use(i.urlencoded({extended:!1})),b.use(n("_method")),b.use(c({secret:process.env.COOKIE_SECRET_KEY,resave:!1,saveUninitialized:!1,store:new l({mongooseConnection:a.connection,ttl:604800})})),b.use(u.initialize()),b.use(u.session()),b.use(p()),b.use((e,t,o)=>{t.locals.user=e.user,t.locals.errorMsg=e.flash("error"),t.locals.successMsg=e.flash("success"),t.locals.dateFormat=e=>d(e),t.locals.capitalize=e=>"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1),o()}),b.get("/",(e,t)=>{t.render("home",{pageTitle:"Bookshelf",path:e.path})}),b.use(m),b.use(g),b.use(f),b.use(y),b.use(h),b.get("/movies",(e,t)=>{t.render("movie",{pageTitle:"Movie Fight"})}),b.get("*",(e,t)=>{t.render("404",{pageTitle:"404"})});const w=process.env.PORT||3e3;b.listen(w,()=>{console.log(s.blue("=====================")),console.log(s.bold("http://localhost:"+s.bold.red(w))),console.log(s.blue("====================="))})},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("method-override")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("connect-mongo")},function(e,t){e.exports=require("date-fns/formatDistanceToNow")},function(e,t){e.exports=require("connect-flash")},function(e,t,o){const r=o(0).Router(),i=o(2),a=o(18),s=o(19),n=o(7),c=o(3),{isLoggedIn:l,isBookOwner:u}=o(4),d=o(21);r.get("/books",async(e,t)=>{try{let o=n.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(o=o.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(o=o.where("language").equals(e.query.language));const r=await o.find({status:"public"}).populate("creator").exec();t.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:r})}catch(e){t.render("error",{backButton:"/books",error:e})}}),r.post("/books",l,d,async(e,t)=>{try{a.access("./public/uploads/img/resized",e=>{e&&a.mkdirSync("./public/uploads/img/resized")});const o=e.files.coverImagePath[0].filename,r="/uploads/img/resized/"+o,i=e.files.pdfFile[0].filename,l=e.files.coverImagePath[0].path;await s(l).resize(250,400).toFile("./public"+r);const u=new n({title:e.body.title,author:e.body.author,description:e.body.description,coverImageName:o,pdfFileName:i,pageNo:e.body.pageNo,language:e.body.language,status:e.body.status,creator:e.user._id});await u.save();const d=await c.findById(e.user._id);d.posts.push(u),await d.save(),e.flash("success","Post created."),t.redirect("/books")}catch(o){e.flash("error","Failed to create. Try Again"),t.redirect("/books")}}),r.get("/books/new",l,(e,t)=>{t.render("books/new",{pageTitle:"Add Books",path:e.path})}),r.get("/books/:id",async(e,t)=>{try{const o=await n.findById(e.params.id).populate("comments").populate("creator").exec();t.render("books/show",{pageTitle:o.title,book:o})}catch(e){console.log(e),t.redirect("/books")}}),r.get("/books/:id/edit",u,async(e,t)=>{try{const o=await n.findById(e.params.id);t.render("books/edit",{pageTitle:o.title,book:o})}catch(e){console.log(e),t.redirect("/books")}}),r.put("/books/:id",u,d,async(e,t)=>{try{const o=await n.findById(e.params.id);if(e.body.title&&(o.title=e.body.title),e.body.author&&(o.author=e.body.author),e.body.description&&(o.description=e.body.description),e.body.pageNo&&(o.pageNo=e.body.pageNo),e.body.language&&(o.language=e.body.language),e.body.status&&(o.status=e.body.status),e.body.publishDate&&(o.publishDate=e.body.publishDate),e.files.coverImagePath){const{filename:t}=e.files.coverImagePath[0],r=i.join("public","uploads","img",o.coverImageName);a.unlink(r,e=>{e&&console.log(e)});const n=i.join("public","uploads","img","resized",o.coverImageName);a.unlink(n,e=>{e&&console.log(e)});const c=e.files.coverImagePath[0].path,l=i.join("public","uploads","img","resized",t);await s(c).resize(250,400).toFile(l),o.coverImageName=t}if(e.files.pdfFile){const{filename:t}=e.files.pdfFile[0],r=i.join("public","uploads","pdf",o.pdfFileName);a.unlink(r,e=>{e&&console.log(e)}),o.pdfFileName=t}await o.save(),e.flash("success","Post updated."),t.redirect("/books/"+e.params.id)}catch(o){e.flash("error","Failed to update. Try Again."),t.redirect("back")}}),r.delete("/books/:id",u,async(e,t)=>{try{const o=await n.findById(e.params.id),r=i.join("public","uploads","img",o.coverImageName),s=i.join("public","uploads","img","resized",o.coverImageName),c=i.join("public","uploads","pdf",o.pdfFileName);a.unlink(r,e=>console.log(e)),a.unlink(s,e=>console.log(e)),a.unlink(c,e=>console.log(e)),await o.remove(),e.flash("success","Post deleted."),t.redirect("/books")}catch(o){e.flash("error","Failed to delete. Try Again."),t.redirect("/books")}}),e.exports=r},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("sharp")},function(e,t){e.exports=require("passport-local-mongoose")},function(e,t,o){const r=o(22),i=o(2),a=r.diskStorage({destination:function(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?o(null,i.join("public","uploads","img")):t.originalname.match(/\.pdf$/i)&&o(null,i.join("public","uploads","pdf"))},filename:function(e,t,o){const r=t.originalname.split(" ").join("_");o(null,`${Date.now()}_${r}`)}}),s=r({storage:a,limits:1e5,fileFilter(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||o(new Error("File type not allowed.")),o(null,!0)}}).fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);e.exports=s},function(e,t){e.exports=require("multer")},function(e,t,o){const r=o(0).Router(),i=o(5),a=o(3),{ifLoggedIn:s}=o(4);r.get("/signup",s,(e,t)=>{t.render("auth/signup",{pageTitle:"Signup"})}),r.post("/signup",s,async(e,t)=>{try{const o=await a.find({username:e.body.username}),r=e.body.username+Math.round(100*Math.random()).toString();if(1===o.length)throw e.flash("error",`${e.body.username} already taken. Try ${r}`),new Error("username already used.");const{username:s,password:n,email:c,gender:l,age:u,fullName:d}=e.body,p=new a({username:s,email:c,gender:l,age:u,fullName:d});await p.setPassword(n),await p.save(),i.authenticate("local")(e,t,()=>{e.flash("success","Welcome to bookshelf, "+p.fullName),t.redirect("/books")})}catch(e){console.log(e),t.redirect("/signup")}}),r.get("/login",s,(e,t)=>{t.render("auth/login",{pageTitle:"Login"})}),r.post("/login",s,i.authenticate("local",{successRedirect:"/books",successMessage:"Successfully logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,t)=>{}),r.get("/auth/google",i.authenticate("google",{scope:["profile","email"]})),r.get("/auth/google/cb",i.authenticate("google"),(e,t)=>{e.flash("success","Successfully logged in."),t.redirect("/books")}),r.get("/logout",(e,t)=>{e.logOut(),e.flash("success","Successfully logged out."),t.redirect("/books")}),e.exports=r},function(e,t,o){const r=o(0).Router(),i=o(7),a=o(8),{isLoggedIn:s,isCommentOwner:n}=o(4);r.post("/books/:id/comments",s,async(e,t)=>{try{const o=await i.findById(e.params.id),r=new a({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await r.save(),o.comments.push(r),await o.save(),t.redirect("/books/"+e.params.id)}catch(o){t.redirect("/books/"+e.params.id),console.log(o)}}),r.get("/books/:book_id/comments/:comment_id/edit",n,async(e,t)=>{const o=await a.findById(e.params.comment_id);t.render("comments/edit",{pageTitle:"Edit comments",bookId:e.params.book_id,comment:o})}),r.put("/books/:book_id/comments/:comment_id",n,async(e,t)=>{const o=await a.findById(e.params.comment_id);e.body.content&&(o.content=e.body.content),await o.save(),t.redirect("/books/"+e.params.book_id)}),r.delete("/books/:book_id/comments/:comment_id",n,async(e,t)=>{const o=await a.findById(e.params.comment_id);await o.remove(),t.redirect("/books/"+e.params.book_id)}),e.exports=r},function(e,t,o){const r=o(0).Router(),i=o(3),{isLoggedIn:a}=o(4);r.get("/profile/:id",async(e,t)=>{try{const o=await i.findById(e.params.id).populate("posts").exec();t.render("profile/index",{pageTitle:o.fullName,userProfile:o})}catch(e){console.log("profile.js line 13",e),t.send({error:e})}}),r.put("/profile/:id/edit",a,async(e,t)=>{t.send("edit profile")}),r.delete("/profile/:id",a,async(e,t)=>{t.send("delete user account")}),e.exports=r},function(e,t,o){const r=o(0).Router(),{fetchRecipe:i,getRecipeDetails:a}=o(27);r.get("/recipes",async(e,t)=>{try{const o=await i(e.query.q);t.render("recipes/index",{pageTitle:"Search Recipes",queryStr:e.query.q,recipes:o})}catch(e){t.render("404",{error:e})}}),r.get("/recipes/:id",async(e,t)=>{try{const o=await a(e.params.id);t.render("recipes/show",{pageTitle:"Recipe",data:o})}catch(e){t.render("404",{pageTitle:"404"})}}),r.get("/recipes/api/:id",async(e,t)=>{try{const o=await a(e.params.id);t.send(o)}catch(e){t.render("404",{pageTitle:"404"})}}),e.exports=r},function(e,t,o){const r=o(28).default;o(6).config();e.exports={fetchRecipe:async e=>{const t={url:"https://api.spoonacular.com/recipes/complexSearch/",params:{apiKey:process.env.SPOONACULAR_API_KEY,query:e,number:100}};try{return(await r(t)).data.results}catch(e){throw"API server is down. Try Again."}},getRecipeDetails:async e=>{const t={url:`https://api.spoonacular.com/recipes/${e}/information`,params:{apiKey:process.env.SPOONACULAR_API_KEY}};try{return(await r(t)).data}catch(e){throw"API server is down. Try Again."}}}},function(e,t){e.exports=require("axios")},function(e,t,o){const r=o(1);o(6).config();(async()=>{try{await r.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}),console.log("database connected!!")}catch(e){console.log(e)}})()},function(e,t,o){const r=o(5),i=o(31).Strategy,a=o(32).Strategy,s=o(3);r.serializeUser(s.serializeUser()),r.deserializeUser(s.deserializeUser()),r.use(new i(s.authenticate())),r.use(new a({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/cb"},async(e,t,o,r)=>{try{const e=await s.findOne({googleId:o.id});if(e)return r(null,e);const t=new s({username:o.displayName.toLowerCase().split(" ").join("_"),fullName:o.displayName,googleId:o.id,thumbnail:o.photos[0].value,email:o.emails[0].value});await t.save(),r(null,t)}catch(e){console.log(e)}}))},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("passport-google-oauth20")}]);