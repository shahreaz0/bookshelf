!function(e){var o={};function t(i){if(o[i])return o[i].exports;var r=o[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}t.m=e,t.c=o,t.d=function(e,o,i){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var r in e)t.d(i,r,function(o){return e[o]}.bind(null,r));return i},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=9)}([function(e,o){e.exports=require("express")},function(e,o){e.exports=require("mongoose")},function(e,o){e.exports=require("path")},function(e,o,t){const i=t(1),r=t(20),n=i.Schema({username:{type:String,maxlength:20,unique:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://image.flaticon.com/icons/svg/758/758669.svg"},posts:[{type:i.Schema.Types.ObjectId,ref:"Book"}]},{timestamps:!0});n.plugin(r),e.exports=i.model("User",n)},function(e,o,t){const i=t(6),r=t(8);o.isLoggedIn=(e,o,t)=>{if(e.isAuthenticated())return t();e.flash("error","You are not logged in"),o.redirect("/login")},o.ifLoggedIn=(e,o,t)=>{if(e.isAuthenticated())return o.redirect("/books");t()},o.isBookOwner=async(e,o,t)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),o.redirect("/login");if((await i.findById(e.params.id)).creator.equals(e.user._id))return t();e.flash("error","You can't edit other's post."),o.redirect("/books/"+e.params.id)},o.isCommentOwner=async(e,o,t)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),o.redirect("/login");if((await r.findById(e.params.comment_id)).author===e.user.username)return t();e.flash("error","Permission denied"),o.redirect("back")}},function(e,o){e.exports=require("passport")},function(e,o,t){const i=t(1),r=t(2),n=i.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImageName:{type:String,required:!0},pdfFileName:{type:String,required:!0},pageNo:{type:Number,min:1},language:{type:String},publishDate:{type:Date,default:new Date},status:{type:String,default:"public",enum:["public","private"]},comments:[{type:i.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:i.Schema.Types.ObjectId,ref:"User"}});n.virtual("coverImageUrl").get((function(){if(this.coverImageName)return"\\"+r.join("uploads","img","resized",this.coverImageName)})),n.virtual("pdfFileUrl").get((function(){if(this.pdfFileName)return"\\"+r.join("uploads","pdf",this.pdfFileName)})),e.exports=i.model("Book",n)},function(e,o){e.exports=require("dotenv")},function(e,o,t){const i=t(1),r=i.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});e.exports=i.model("Comment",r)},function(e,o,t){e.exports=t(10)},function(e,o,t){const i=t(2),r=t(0),n=t(1),s=t(11),a=t(12),l=t(13),c=t(14)(l),u=t(5),d=t(15),p=t(16);t(7).config();const g=t(17),m=t(23),f=t(24),y=t(25);t(26),t(27);const b=r();b.set("views",i.join("views")),b.set("view engine","ejs"),b.use(r.static(i.join("public"))),b.use(r.urlencoded({extended:!1})),b.use(a("_method")),b.use(l({secret:process.env.COOKIE_SECRET_KEY,resave:!1,saveUninitialized:!1,store:new c({mongooseConnection:n.connection,ttl:604800})})),b.use(u.initialize()),b.use(u.session()),b.use(p()),b.use((e,o,t)=>{o.locals.user=e.user,o.locals.errorMsg=e.flash("error"),o.locals.successMsg=e.flash("success"),o.locals.dateFormat=e=>d(e),o.locals.capitalize=e=>"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1),t()}),b.get("/",(e,o)=>{o.render("home",{pageTitle:"Bookshelf",path:e.path})}),b.use(m),b.use(g),b.use(f),b.use(y),b.get("*",(e,o)=>{o.render("404",{pageTitle:"404"})});const h=process.env.PORT||3e3;b.listen(h,()=>{console.log(s.blue("=====================")),console.log(s.bold("http://localhost:"+s.bold.red(h))),console.log(s.blue("====================="))})},function(e,o){e.exports=require("chalk")},function(e,o){e.exports=require("method-override")},function(e,o){e.exports=require("express-session")},function(e,o){e.exports=require("connect-mongo")},function(e,o){e.exports=require("date-fns/formatDistanceToNow")},function(e,o){e.exports=require("connect-flash")},function(e,o,t){const i=t(0).Router(),r=t(2),n=t(18),s=t(19),a=t(6),l=t(3),{isLoggedIn:c,isBookOwner:u}=t(4),d=t(21);i.get("/books",async(e,o)=>{try{let t=a.find();e.query.title&&(t=t.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(t=t.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(t=t.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(t=t.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(t=t.where("language").equals(e.query.language));const i=await t.find({status:"public"}).populate("creator").exec();o.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:i})}catch(e){o.render("error",{backButton:"/books",error:e})}}),i.post("/books",c,d,async(e,o)=>{try{n.access("./public/uploads/img/resized",e=>{e&&n.mkdirSync("./public/uploads/img/resized")});const t=e.files.coverImagePath[0].filename,i="/uploads/img/resized/"+t,r=e.files.pdfFile[0].filename,c=e.files.coverImagePath[0].path;await s(c).resize(250,400).toFile("./public"+i);const u=new a({title:e.body.title,author:e.body.author,description:e.body.description,coverImageName:t,pdfFileName:r,pageNo:e.body.pageNo,language:e.body.language,status:e.body.status,creator:e.user._id});await u.save();const d=await l.findById(e.user._id);d.posts.push(u),await d.save(),e.flash("success","Post created."),o.redirect("/books")}catch(t){e.flash("error","Failed to create. Try Again"),o.redirect("/books")}}),i.get("/books/new",c,(e,o)=>{o.render("books/new",{pageTitle:"Add Books",path:e.path})}),i.get("/books/:id",async(e,o)=>{try{const t=await a.findById(e.params.id).populate("comments").populate("creator").exec();o.render("books/show",{pageTitle:t.title,book:t})}catch(e){console.log(e),o.redirect("/books")}}),i.get("/books/:id/edit",u,async(e,o)=>{try{const t=await a.findById(e.params.id);o.render("books/edit",{pageTitle:t.title,book:t})}catch(e){console.log(e),o.redirect("/books")}}),i.put("/books/:id",u,d,async(e,o)=>{try{const t=await a.findById(e.params.id);if(e.body.title&&(t.title=e.body.title),e.body.author&&(t.author=e.body.author),e.body.description&&(t.description=e.body.description),e.body.pageNo&&(t.pageNo=e.body.pageNo),e.body.language&&(t.language=e.body.language),e.body.status&&(t.status=e.body.status),e.body.publishDate&&(t.publishDate=e.body.publishDate),e.files.coverImagePath){const{filename:o}=e.files.coverImagePath[0],i=r.join("public","uploads","img",t.coverImageName);n.unlink(i,e=>{e&&console.log(e)});const a=r.join("public","uploads","img","resized",t.coverImageName);n.unlink(a,e=>{e&&console.log(e)});const l=e.files.coverImagePath[0].path,c=r.join("public","uploads","img","resized",o);await s(l).resize(250,400).toFile(c),t.coverImageName=o}if(e.files.pdfFile){const{filename:o}=e.files.pdfFile[0],i=r.join("public","uploads","pdf",t.pdfFileName);n.unlink(i,e=>{e&&console.log(e)}),t.pdfFileName=o}await t.save(),e.flash("success","Post updated."),o.redirect("/books/"+e.params.id)}catch(t){e.flash("error","Failed to update. Try Again."),o.redirect("back")}}),i.delete("/books/:id",u,async(e,o)=>{try{const t=await a.findById(e.params.id),i=r.join("public","uploads","img",t.coverImageName),s=r.join("public","uploads","img","resized",t.coverImageName),l=r.join("public","uploads","pdf",t.pdfFileName);n.unlink(i,e=>console.log(e)),n.unlink(s,e=>console.log(e)),n.unlink(l,e=>console.log(e)),await t.remove(),e.flash("success","Post deleted."),o.redirect("/books")}catch(t){e.flash("error","Failed to delete. Try Again."),o.redirect("/books")}}),e.exports=i},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("sharp")},function(e,o){e.exports=require("passport-local-mongoose")},function(e,o,t){const i=t(22),r=t(2),n=i.diskStorage({destination:function(e,o,t){o.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?t(null,r.join("public","uploads","img")):o.originalname.match(/\.pdf$/i)&&t(null,r.join("public","uploads","pdf"))},filename:function(e,o,t){const i=o.originalname.split(" ").join("_");t(null,`${Date.now()}_${i}`)}}),s=i({storage:n,limits:1e5,fileFilter(e,o,t){o.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||t(new Error("File type not allowed.")),t(null,!0)}}).fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);e.exports=s},function(e,o){e.exports=require("multer")},function(e,o,t){const i=t(0).Router(),r=t(5),n=t(3),{ifLoggedIn:s}=t(4);i.get("/signup",s,(e,o)=>{o.render("auth/signup",{pageTitle:"Signup"})}),i.post("/signup",s,async(e,o)=>{try{const t=await n.find({username:e.body.username}),i=e.body.username+Math.round(100*Math.random()).toString();if(1===t.length)throw e.flash("error",`${e.body.username} already taken. Try ${i}`),new Error("username already used.");const{username:s,password:a,email:l,gender:c,age:u,fullName:d}=e.body,p=new n({username:s,email:l,gender:c,age:u,fullName:d});await p.setPassword(a),await p.save(),r.authenticate("local")(e,o,()=>{e.flash("success","Welcome to bookshelf, "+p.fullName),o.redirect("/books")})}catch(e){console.log(e),o.redirect("/signup")}}),i.get("/login",s,(e,o)=>{o.render("auth/login",{pageTitle:"Login"})}),i.post("/login",s,r.authenticate("local",{successRedirect:"/books",successMessage:"Successfully logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,o)=>{}),i.get("/auth/google",r.authenticate("google",{scope:["profile","email"]})),i.get("/auth/google/cb",r.authenticate("google"),(e,o)=>{e.flash("success","Successfully logged in."),o.redirect("/books")}),i.get("/logout",(e,o)=>{e.logOut(),e.flash("success","Successfully logged out."),o.redirect("/books")}),e.exports=i},function(e,o,t){const i=t(0).Router(),r=t(6),n=t(8),{isLoggedIn:s,isCommentOwner:a}=t(4);i.post("/books/:id/comments",s,async(e,o)=>{try{const t=await r.findById(e.params.id),i=new n({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await i.save(),t.comments.push(i),await t.save(),o.redirect("/books/"+e.params.id)}catch(t){o.redirect("/books/"+e.params.id),console.log(t)}}),i.get("/books/:book_id/comments/:comment_id/edit",a,async(e,o)=>{const t=await n.findById(e.params.comment_id);o.render("comments/edit",{pageTitle:"Edit comments",bookId:e.params.book_id,comment:t})}),i.put("/books/:book_id/comments/:comment_id",a,async(e,o)=>{const t=await n.findById(e.params.comment_id);e.body.content&&(t.content=e.body.content),await t.save(),o.redirect("/books/"+e.params.book_id)}),i.delete("/books/:book_id/comments/:comment_id",a,async(e,o)=>{const t=await n.findById(e.params.comment_id);await t.remove(),o.redirect("/books/"+e.params.book_id)}),e.exports=i},function(e,o,t){const i=t(0).Router(),r=t(3),{isLoggedIn:n}=t(4);i.get("/profile/:id",async(e,o)=>{try{const t=await r.findById(e.params.id).populate("posts").exec();o.render("profile/index",{pageTitle:t.fullName,userProfile:t})}catch(e){console.log("profile.js line 13",e),o.send({error:e})}}),i.put("/profile/:id/edit",n,async(e,o)=>{o.send("edit profile")}),i.delete("/profile/:id",n,async(e,o)=>{o.send("delete user account")}),e.exports=i},function(e,o,t){const i=t(1);t(7).config();(async()=>{try{await i.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}),console.log("database connected!!")}catch(e){console.log(e)}})()},function(e,o,t){const i=t(5),r=t(28).Strategy,n=t(29).Strategy,s=t(3);i.serializeUser(s.serializeUser()),i.deserializeUser(s.deserializeUser()),i.use(new r(s.authenticate())),i.use(new n({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/cb"},async(e,o,t,i)=>{try{const e=await s.findOne({googleId:t.id});if(console.log(e),e)return i(null,e);const o=new s({username:t.displayName.toLowerCase().split(" ").join("_"),fullName:t.displayName,googleId:t.id,thumbnail:t.photos[0].value,email:t.emails[0].value});await o.save(),i(null,o)}catch(e){console.log(e)}}))},function(e,o){e.exports=require("passport-local")},function(e,o){e.exports=require("passport-google-oauth20")}]);