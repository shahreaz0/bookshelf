!function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=4)}([function(e,t){e.exports=require("path")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("mongoose")},function(e,t,o){e.exports=o(5)},function(e,t,o){const r=o(0),n=o(1),i=o(6);o(2).config();const a=o(7);o(12);const u=n();u.set("views",r.join("views")),u.set("view engine","ejs"),u.use(n.json()),u.use(n.urlencoded({extended:!1})),u.use(n.static(r.join("public"))),u.get("/",(e,t)=>{t.render("home",{pageTitle:"Bookshelf",path:e.path})}),u.use(a),u.get("*",(e,t)=>{t.render("404",{pageTitle:"404"})});const l=process.env.PORT||"3000";u.listen(l,()=>{console.log(i.blue("=====================")),console.log(i.bold("http://localhost:"+i.bold.red(l))),console.log(i.blue("====================="))})},function(e,t){e.exports=require("chalk")},function(e,t,o){const r=o(1).Router(),n=o(0),i=o(8),a=o(9),u=o(10),l=o(11);var s=a.diskStorage({destination:function(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?o(null,n.join("public","uploads","img")):t.originalname.match(/\.pdf$/i)&&o(null,n.join("public","uploads","pdf"))},filename:function(e,t,o){const r=t.originalname.split(" ").join("-");o(null,`${Date.now()}-${r}`)}});const c=a({storage:s,limits:1e5,fileFilter(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||o(new Error("File type not allowed.")),o(null,!0)}});r.get("/books",async(e,t)=>{try{let o=l.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(o=o.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(o=o.where("language").equals(e.query.language));const r=await o.exec();t.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:r})}catch(e){t.render("error",{backButton:"/books",error:e})}});const p=c.fields([{name:"coverImagePath",maxCount:3},{name:"pdfFile",maxCount:3}]);r.post("/books",p,async(e,t)=>{try{i.access("./public/uploads/img/resized",e=>{e&&i.mkdirSync("./public/uploads/img/resized")});const o="/uploads/img/resized/"+e.files.coverImagePath[0].filename,r="/uploads/pdf/"+e.files.pdfFile[0].filename,{path:n}=e.files.coverImagePath[0];await u(n).resize(220,350).toFile("./public"+o);const a=new l({title:e.body.title,author:e.body.author,description:e.body.description,coverImagePath:o,pdfPath:r,pageNo:e.body.pageNo,language:e.body.language});await a.save(),t.redirect("/books")}catch(e){i.unlink("./public/uploads/img/resized/"+coverFilename,e=>{throw e}),i.unlink("./public/uploads/img/"+coverFilename,e=>{throw e}),i.unlink("./public/"+pdfPath,e=>{throw e}),console.log(e),t.redirect("/books")}}),r.get("/books/new",(e,t)=>{t.render("books/new",{pageTitle:"Add Books",path:e.path})}),e.exports=r},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("sharp")},function(e,t,o){const r=o(3),n=r.Schema({title:{type:String,required:!0,trim:!0},author:{type:String,required:!0},description:{type:String,trim:!0},coverImagePath:{type:String,required:!0},pdfPath:{type:String,required:!0},pageNo:{type:Number},language:{type:String},publishDate:{type:Date,default:new Date}});e.exports=r.model("Book",n)},function(e,t,o){const r=o(3);o(2).config();(async()=>{try{await r.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0}),console.log("database connected!!")}catch(e){console.log(e)}})()}]);