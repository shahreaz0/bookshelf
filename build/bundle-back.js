!function(e){var o={};function t(i){if(o[i])return o[i].exports;var n=o[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.m=e,t.c=o,t.d=function(e,o,i){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var n in e)t.d(i,n,function(o){return e[o]}.bind(null,n));return i},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=9)}([function(e,o){e.exports=require("mongoose")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("passport")},function(e,o){e.exports=require("dotenv")},function(e,o,t){const i=t(0),n=t(2),r=i.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImageName:{type:String,required:!0},pdfFileName:{type:String,required:!0},pageNo:{type:Number,min:1},language:{type:String},publishDate:{type:Date,default:new Date},comments:[{type:i.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:i.Schema.Types.ObjectId,ref:"User"}});r.virtual("coverImageUrl").get((function(){if(this.coverImageName)return"\\"+n.join("uploads","img","resized",this.coverImageName)})),r.virtual("pdfFileUrl").get((function(){if(this.pdfFileName)return"\\"+n.join("uploads","pdf",this.pdfFileName)})),e.exports=i.model("Book",r)},function(e,o,t){const i=t(0),n=i.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});e.exports=i.model("Comment",n)},function(e,o,t){const i=t(0),n=t(21),r=i.Schema({username:{type:String,maxlength:20,required:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://tinyurl.com/y6qo86km"}},{timestamps:!0});r.plugin(n),e.exports=i.model("User",r)},function(e,o,t){const i=t(5),n=t(6);o.isLoggedIn=(e,o,t)=>{if(!e.isAuthenticated())return o.redirect("/login");t()},o.ifLoggedIn=(e,o,t)=>{if(e.isAuthenticated())return o.redirect("/books");t()},o.isBookOwner=async(e,o,t)=>{if(!e.isAuthenticated())return o.redirect("/login");if((await i.findById(e.params.id)).creator.equals(e.user._id))return t();o.redirect("back")},o.isCommentOwner=async(e,o,t)=>{if(e.isAuthenticated()||o.redirect("/login"),(await n.findById(e.params.comment_id)).author===e.user.username)return t();o.redirect("back")}},function(e,o,t){e.exports=t(10)},function(e,o,t){const i=t(2),n=t(1),r=t(0),a=t(11),s=t(12),c=t(13),l=t(14)(c),u=t(3),d=t(15);t(4).config(),t(16);const p=t(17),g=t(22),m=t(23);t(24);const f=n();f.set("views",i.join("views")),f.set("view engine","ejs"),f.use(n.json()),f.use(n.urlencoded({extended:!1})),f.use(n.static(i.join("public"))),f.use(s("_method")),f.use(c({secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,store:new l({mongooseConnection:r.connection,ttl:604800})})),f.use(u.initialize()),f.use(u.session()),f.use((e,o,t)=>{o.locals.user=e.user,o.locals.dateFormat=e=>d(new Date,e,{addSuffix:!0}),t()}),f.get("/",(e,o)=>{o.render("home",{pageTitle:"Bookshelf",path:e.path})}),f.use(g),f.use(p),f.use(m),f.get("*",(e,o)=>{o.render("404",{pageTitle:"404"})});const b=process.env.PORT||"3000";f.listen(b,()=>{console.log(a.blue("=====================")),console.log(a.bold("http://localhost:"+a.bold.red(b))),console.log(a.blue("====================="))})},function(e,o){e.exports=require("chalk")},function(e,o){e.exports=require("method-override")},function(e,o){e.exports=require("express-session")},function(e,o){e.exports=require("connect-mongo")},function(e,o){e.exports=require("date-fns/formatDistance")},function(e,o,t){const i=t(0);t(4).config();(async()=>{try{await i.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0}),console.log("database connected!!")}catch(e){console.log(e)}})()},function(e,o,t){const i=t(1).Router(),n=t(2),r=t(18),a=t(19),s=t(20),c=t(5),{isLoggedIn:l,isBookOwner:u}=(t(6),t(7),t(8)),d=a.diskStorage({destination:function(e,o,t){o.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?t(null,n.join("public","uploads","img")):o.originalname.match(/\.pdf$/i)&&t(null,n.join("public","uploads","pdf"))},filename:function(e,o,t){const i=o.originalname.split(" ").join("_");t(null,`${Date.now()}_${i}`)}}),p=a({storage:d,limits:1e5,fileFilter(e,o,t){o.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||t(new Error("File type not allowed.")),t(null,!0)}}).fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);i.get("/books",async(e,o)=>{try{let t=c.find();e.query.title&&(t=t.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(t=t.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(t=t.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(t=t.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(t=t.where("language").equals(e.query.language));const i=await t.populate("creator").exec();o.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:i})}catch(e){o.render("error",{backButton:"/books",error:e})}}),i.post("/books",l,p,async(e,o)=>{try{r.access("./public/uploads/img/resized",e=>{e&&r.mkdirSync("./public/uploads/img/resized")});const t=e.files.coverImagePath[0].filename,i="/uploads/img/resized/"+t,n=e.files.pdfFile[0].filename,a=e.files.coverImagePath[0].path;await s(a).resize(250,400).toFile("./public"+i);const l=new c({title:e.body.title,author:e.body.author,description:e.body.description,coverImageName:t,pdfFileName:n,pageNo:e.body.pageNo,language:e.body.language,creator:e.user._id});await l.save(),o.redirect("/books")}catch(e){console.log(e),o.redirect("/books")}}),i.get("/books/new",l,(e,o)=>{o.render("books/new",{pageTitle:"Add Books",path:e.path})}),i.get("/books/:id",async(e,o)=>{try{const t=await c.findById(e.params.id).populate("comments").populate("creator").exec();o.render("books/show",{pageTitle:t.title,book:t})}catch(e){console.log(e),o.redirect("/books")}}),i.get("/books/:id/edit",u,async(e,o)=>{try{const t=await c.findById(e.params.id);o.render("books/edit",{pageTitle:t.title,book:t})}catch(e){console.log(e),o.redirect("/books")}}),i.put("/books/:id",u,p,async(e,o)=>{try{const t=await c.findById(e.params.id);if(e.body.title&&(t.title=e.body.title),e.body.author&&(t.author=e.body.author),e.body.description&&(t.description=e.body.description),e.body.pageNo&&(t.pageNo=e.body.pageNo),e.body.language&&(t.language=e.body.language),e.body.publishDate&&(t.publishDate=e.body.publishDate),e.files.coverImagePath){const{filename:o}=e.files.coverImagePath[0],i=n.join("public","uploads","img",t.coverImageName);r.unlink(i,e=>{e&&console.log(e)});const a=n.join("public","uploads","img","resized",t.coverImageName);r.unlink(a,e=>{e&&console.log(e)});const c=e.files.coverImagePath[0].path,l=n.join("public","uploads","img","resized",o);await s(c).resize(250,400).toFile(l),t.coverImageName=o}if(e.files.pdfFile){const{filename:o}=e.files.pdfFile[0],i=n.join("public","uploads","pdf",t.pdfFileName);r.unlink(i,e=>{e&&console.log(e)}),t.pdfFileName=o}await t.save(),o.redirect("/books/"+e.params.id)}catch(e){console.log(e),o.redirect("back")}}),i.delete("/books/:id",u,async(e,o)=>{try{const t=await c.findById(e.params.id),i=n.join("public","uploads","img",t.coverImageName),a=n.join("public","uploads","img","resized",t.coverImageName),s=n.join("public","uploads","pdf",t.pdfFileName);r.unlink(i,e=>console.log(e)),r.unlink(a,e=>console.log(e)),r.unlink(s,e=>console.log(e)),await t.remove(),o.redirect("/books")}catch(e){console.log(e),o.redirect("/books")}}),e.exports=i},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("multer")},function(e,o){e.exports=require("sharp")},function(e,o){e.exports=require("passport-local-mongoose")},function(e,o,t){const i=t(1).Router(),n=t(3),r=t(7),{ifLoggedIn:a}=t(8);i.get("/signup",a,(e,o)=>{o.render("auth/signup",{pageTitle:"Signup"})}),i.post("/signup",a,async(e,o)=>{try{if(1===(await r.find({username:e.body.username})).length)throw new Error("username already used.");const{username:t,password:i,email:a,gender:s,age:c,fullName:l}=e.body,u=new r({username:t,email:a,gender:s,age:c,fullName:l});await u.setPassword(i),await u.save(),n.authenticate("local")(e,o,()=>{o.redirect("/books")})}catch(e){console.log(e),o.redirect("/signup")}}),i.get("/login",a,(e,o)=>{o.render("auth/login",{pageTitle:"Login"})}),i.post("/login",a,n.authenticate("local",{successRedirect:"/books",successMessage:"You are logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,o)=>{}),i.get("/logout",(e,o)=>{e.logOut(),o.redirect("/books")}),e.exports=i},function(e,o,t){const i=t(1).Router(),n=t(5),r=t(6),{isLoggedIn:a,isCommentOwner:s}=t(8);i.post("/books/:id/comments",a,async(e,o)=>{try{const t=await n.findById(e.params.id),i=new r({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await i.save(),t.comments.push(i),await t.save(),o.redirect("/books/"+e.params.id)}catch(t){o.redirect("/books/"+e.params.id),console.log(t)}}),i.get("/books/:book_id/comments/:comment_id/edit",s,async(e,o)=>{const t=await r.findById(e.params.comment_id);o.render("comments/edit",{pageTitle:"Edit comments",bookId:e.params.book_id,comment:t})}),i.put("/books/:book_id/comments/:comment_id",s,async(e,o)=>{const t=await r.findById(e.params.comment_id);e.body.content&&(t.content=e.body.content),await t.save(),o.redirect("/books/"+e.params.book_id)}),i.delete("/books/:book_id/comments/:comment_id",s,async(e,o)=>{const t=await r.findById(e.params.comment_id);await t.remove(),o.redirect("/books/"+e.params.book_id)}),e.exports=i},function(e,o,t){const i=t(3),n=t(25).Strategy,r=t(7);t(4).config(),i.serializeUser(r.serializeUser()),i.deserializeUser(r.deserializeUser()),i.use(new n(r.authenticate()))},function(e,o){e.exports=require("passport-local")}]);