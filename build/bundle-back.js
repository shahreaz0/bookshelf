!function(e){var o={};function t(i){if(o[i])return o[i].exports;var r=o[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}t.m=e,t.c=o,t.d=function(e,o,i){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var r in e)t.d(i,r,function(o){return e[o]}.bind(null,r));return i},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=4)}([function(e,o){e.exports=require("path")},function(e,o){e.exports=require("express")},function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("mongoose")},function(e,o,t){e.exports=t(5)},function(e,o,t){const i=t(0),r=t(1),n=t(6),a=t(7);t(2).config();const l=t(8);t(13);const s=r();s.set("views",i.join("views")),s.set("view engine","ejs"),s.use(r.json()),s.use(r.urlencoded({extended:!1})),s.use(r.static(i.join("public"))),s.use(a("_method")),s.get("/",(e,o)=>{o.render("home",{pageTitle:"Bookshelf",path:e.path})}),s.use(l),s.get("*",(e,o)=>{o.render("404",{pageTitle:"404"})});const u=process.env.PORT||"3000";s.listen(u,()=>{console.log(n.blue("=====================")),console.log(n.bold("http://localhost:"+n.bold.red(u))),console.log(n.blue("====================="))})},function(e,o){e.exports=require("chalk")},function(e,o){e.exports=require("method-override")},function(e,o,t){const i=t(1).Router(),r=t(0),n=t(9),a=t(10),l=t(11),s=t(12);var u=a.diskStorage({destination:function(e,o,t){o.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?t(null,r.join("public","uploads","img")):o.originalname.match(/\.pdf$/i)&&t(null,r.join("public","uploads","pdf"))},filename:function(e,o,t){const i=o.originalname.split(" ").join("_");t(null,`${Date.now()}_${i}`)}});const c=a({storage:u,limits:1e5,fileFilter(e,o,t){o.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||t(new Error("File type not allowed.")),t(null,!0)}}).fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);i.get("/books",async(e,o)=>{try{let t=s.find();e.query.title&&(t=t.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(t=t.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(t=t.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(t=t.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(t=t.where("language").equals(e.query.language));const i=await t.exec();o.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:i})}catch(e){o.render("error",{backButton:"/books",error:e})}}),i.post("/books",c,async(e,o)=>{try{n.access("./public/uploads/img/resized",e=>{e&&n.mkdirSync("./public/uploads/img/resized")});const t=e.files.coverImagePath[0].filename,i="/uploads/img/resized/"+t,r=e.files.pdfFile[0].filename,a=e.files.coverImagePath[0].path;await l(a).resize(250,400).toFile("./public"+i);const u=new s({title:e.body.title,author:e.body.author,description:e.body.description,coverImageName:t,pdfFileName:r,pageNo:e.body.pageNo,language:e.body.language});await u.save(),o.redirect("/books")}catch(e){console.log(e),o.redirect("/books")}}),i.get("/books/new",(e,o)=>{o.render("books/new",{pageTitle:"Add Books",path:e.path})}),i.get("/books/:id",async(e,o)=>{try{const t=await s.findById(e.params.id);o.render("books/show",{pageTitle:t.title,book:t})}catch(e){console.log(e),o.redirect("/books")}}),i.get("/books/:id/edit",async(e,o)=>{try{const t=await s.findById(e.params.id);o.render("books/edit",{pageTitle:t.title,book:t})}catch(e){console.log(e),o.redirect("/books")}}),i.put("/books/:id",c,async(e,o)=>{try{const t=await s.findById(e.params.id);if(e.body.title&&(t.title=e.body.title),e.body.author&&(t.author=e.body.author),e.body.description&&(t.description=e.body.description),e.body.pageNo&&(t.pageNo=e.body.pageNo),e.body.language&&(t.language=e.body.language),e.body.publishDate&&(t.publishDate=e.body.publishDate),e.files.coverImagePath){const{filename:o}=e.files.coverImagePath[0],i=r.join("public","uploads","img",t.coverImageName);n.unlink(i,e=>{e&&console.log(e)});const a=r.join("public","uploads","img","resized",t.coverImageName);n.unlink(a,e=>{e&&console.log(e)});const s=e.files.coverImagePath[0].path,u=r.join("public","uploads","img","resized",o);await l(s).resize(250,400).toFile(u),t.coverImageName=o}if(e.files.pdfFile){const{filename:o}=e.files.pdfFile[0],i=r.join("public","uploads","pdf",t.pdfFileName);n.unlink(i,e=>{e&&console.log(e)}),t.pdfFileName=o}await t.save(),o.redirect("/books/"+e.params.id)}catch(e){console.log(e),o.redirect("back")}}),e.exports=i},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("multer")},function(e,o){e.exports=require("sharp")},function(e,o,t){const i=t(3),r=t(0),n=i.Schema({title:{type:String,required:!0,trim:!0},author:{type:String,required:!0},description:{type:String,trim:!0},coverImageName:{type:String,required:!0},pdfFileName:{type:String,required:!0},pageNo:{type:Number},language:{type:String},publishDate:{type:Date,default:new Date}});n.virtual("coverImageUrl").get((function(){if(this.coverImageName)return"\\"+r.join("uploads","img","resized",this.coverImageName)})),n.virtual("pdfFileUrl").get((function(){if(this.pdfFileName)return"\\"+r.join("uploads","pdf",this.pdfFileName)})),e.exports=i.model("Book",n)},function(e,o,t){const i=t(3);t(2).config();(async()=>{try{await i.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0}),console.log("database connected!!")}catch(e){console.log(e)}})()}]);