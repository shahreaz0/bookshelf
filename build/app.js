var i=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var N=i(()=>{var _e=require("mongoose"),Ie=async()=>{try{await _e.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}),console.log("database connected!!")}catch(e){console.log(e)}};Ie()});var g=i((Ve,L)=>{var U=require("mongoose"),ve=require("passport-local-mongoose"),D=U.Schema({username:{type:String,maxlength:20,unique:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://image.flaticon.com/icons/svg/758/758669.svg"},posts:[{type:U.Schema.Types.ObjectId,ref:"Book"}]},{timestamps:!0});D.plugin(ve);L.exports=U.model("User",D)});var R=i(()=>{var k=require("passport"),Se=require("passport-local").Strategy,xe=require("passport-google-oauth20").Strategy,y=g();k.serializeUser(y.serializeUser());k.deserializeUser(y.deserializeUser());k.use(new Se(y.authenticate()));k.use(new xe({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/cb"},async(e,t,o,s)=>{try{let a=await y.findOne({googleId:o.id});if(a)return s(null,a);let u=new y({username:o.displayName.toLowerCase().split(" ").join("_"),fullName:o.displayName,googleId:o.id,thumbnail:o.photos[0].value,email:o.emails[0].value});await u.save(),s(null,u)}catch(a){console.log(a)}}))});var d=i((Qe,j)=>{var f=require("mongoose"),Je=require("path"),Be=f.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImg:{url:{type:String},cloudinary_id:{type:String}},pdfBook:{url:{type:String},cloudinary_id:{type:String}},genre:{type:String},language:{type:String},status:{type:String,default:"public",enum:["public","private"]},comments:[{type:f.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:f.Schema.Types.ObjectId,ref:"User"},likes:{type:Number,default:0,min:0},likedUsers:[{type:f.Schema.Types.ObjectId,ref:"Comment"}]},{timestamps:!0});j.exports=f.model("Book",Be)});var $=i((Xe,P)=>{var T=require("express").Router(),A=d();T.get("/",async(e,t)=>{try{let o=await A.find().populate("creator").sort({publishDate:"desc"}).limit(10).exec();t.render("home",{pageTitle:"Bookshelf",books:o,path:e.path})}catch(o){t.render("404",{pageTitle:"404"})}});T.get("/:author/books",async(e,t)=>{try{let o=await A.find({author:e.params.author}).populate("creator").exec();t.render("authors/index",{pageTitle:e.params.author,books:o,path:e.path})}catch(o){t.render("404",{pageTitle:"404"})}});P.exports=T});var C=i((Ze,Y)=>{var M=require("mongoose"),Ue=M.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});Y.exports=M.model("Comment",Ue)});var p=i(h=>{var Te=d(),Ce=C();h.isLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return o();e.flash("error","You are not logged in"),t.redirect("/login")};h.ifLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return t.redirect("/books");o()};h.isBookOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await Te.findById(e.params.id)).creator.equals(e.user._id))return o();e.flash("error","You can't edit other's post."),t.redirect(`/books/${e.params.id}`)};h.isCommentOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await Ce.findById(e.params.comment_id)).author===e.user.username)return o();e.flash("error","Permission denied"),t.redirect("back")}});var G=i((eo,z)=>{var c=require("express").Router(),w=require("passport"),F=g(),{ifLoggedIn:_}=p();c.get("/signup",_,(e,t)=>{t.render("auth/signup",{pageTitle:"Signup"})});c.post("/signup",_,async(e,t)=>{try{let o=await F.find({username:e.body.username}),s=e.body.username+Math.round(Math.random()*100).toString();if(o.length===1)throw e.flash("error",`${e.body.username} already taken. Try ${s}`),new Error("username already used.");let{username:a,password:u,email:he,gender:be,age:ke,fullName:we}=e.body,B=new F({username:a,email:he,gender:be,age:ke,fullName:we});await B.setPassword(u),await B.save(),w.authenticate("local")(e,t,()=>{e.flash("success",`Welcome to bookshelf, ${B.fullName}`),t.redirect("/books")})}catch(o){console.log(o),t.redirect("/signup")}});c.get("/login",_,(e,t)=>{t.render("auth/login",{pageTitle:"Login"})});c.post("/login",_,w.authenticate("local",{successRedirect:"/books",successMessage:"Successfully logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,t)=>{});c.get("/auth/google",w.authenticate("google",{scope:["profile","email"]}));c.get("/auth/google/cb",w.authenticate("google"),(e,t)=>{e.flash("success","Successfully logged in."),t.redirect("/books")});c.get("/logout",(e,t)=>{e.logOut(),e.flash("success","Successfully logged out."),t.redirect("/books")});z.exports=c});var W=i((oo,V)=>{var K=require("multer"),Oe=require("path"),Ee=K.diskStorage({destination:function(e,t,o){o(null,Oe.join("public","uploads"))},filename:function(e,t,o){let s=t.originalname.split(" ").join("_");o(null,`${Date.now()}_${s}`)}}),Ne=K({storage:Ee,limits:1e8,fileFilter(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||o(new Error("File type not allowed.")),o(null,!0)}}),De=Ne.fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);V.exports=De});var Q=i((to,J)=>{var H=require("cloudinary").v2;H.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET,secure:!0});J.exports=H});var se=i((so,te)=>{var l=require("express").Router(),X=require("path"),Z=require("fs-extra"),m=d(),q=g(),{isLoggedIn:ee,isBookOwner:O}=p(),oe=W(),n=Q();l.get("/books",async(e,t)=>{try{let o=m.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(o=o.where("author").regex(new RegExp(e.query.author,"i"))),e.query.genre&&(o=o.where("genre").regex(new RegExp(e.query.genre,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(o=o.where("language").equals(e.query.language));let s=await o.find({status:"public"}).populate("creator").exec();t.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:s})}catch(o){t.render("error",{backButton:"/books",error:o})}});l.post("/books",ee,oe,async(e,t)=>{try{let o=await n.uploader.upload(e.files.coverImagePath[0].path,{public_id:`bookshelf/img/${e.files.coverImagePath[0].filename}`,eager:[{width:250,height:400,fetch_format:"auto"}]}),s=await n.uploader.upload(e.files.pdfFile[0].path,{public_id:`bookshelf/pdf/${e.files.pdfFile[0].filename}`});deleteImg=o.public_id,deletePdf=s.public_id,Z.emptyDirSync(X.join("public","uploads"));let a=new m({title:e.body.title,author:e.body.author,description:e.body.description,genre:e.body.genre,language:e.body.language,status:e.body.status,creator:e.user._id,coverImg:{url:o.eager[0].secure_url,cloudinary_id:o.public_id},pdfBook:{url:s.secure_url,cloudinary_id:s.public_id}});await a.save();let u=await q.findById(e.user._id);u.posts.push(a),await u.save(),e.flash("success","Post created."),t.redirect("/books")}catch(o){await n.uploader.destroy(deleteImg),await n.uploader.destroy(deletePdf),e.flash("error","Failed to create. Try Again"),t.redirect("/books")}});l.get("/books/new",ee,(e,t)=>{t.render("books/new",{pageTitle:"Add Books",path:e.path})});l.get("/books/:id",async(e,t)=>{try{let o=await m.findById(e.params.id).populate("comments").populate("creator").exec();t.render("books/show",{pageTitle:o.title,book:o})}catch(o){t.redirect("/books")}});l.get("/books/:id/edit",O,async(e,t)=>{try{let o=await m.findById(e.params.id);t.render("books/edit",{pageTitle:o.title,book:o})}catch(o){t.redirect("/books")}});l.put("/books/:id",O,oe,async(e,t)=>{try{let o=await m.findById(e.params.id);if(e.body.title&&(o.title=e.body.title),e.body.author&&(o.author=e.body.author),e.body.description&&(o.description=e.body.description),e.body.genre&&(o.genre=e.body.genre),e.body.language&&(o.language=e.body.language),e.body.status&&(o.status=e.body.status),e.body.publishDate&&(o.publishDate=e.body.publishDate),e.files.coverImagePath){await n.uploader.destroy(o.coverImg.cloudinary_id);let s=await n.uploader.upload(e.files.coverImagePath[0].path,{public_id:`bookshelf/img/${e.files.coverImagePath[0].filename}`,eager:[{width:250,height:400,fetch_format:"auto"}]});o.coverImg={url:s.eager[0].secure_url,cloudinary_id:s.public_id}}if(e.files.pdfFile){await n.uploader.destroy(o.pdfBook.cloudinary_id);let s=await n.uploader.upload(e.files.pdfFile[0].path,{public_id:`bookshelf/pdf/${e.files.pdfFile[0].filename}`});o.pdfBook={url:s.secure_url,cloudinary_id:s.public_id}}Z.emptyDirSync(X.join("public","uploads")),await o.save(),e.flash("success","Post updated."),t.redirect("/books/"+e.params.id)}catch(o){e.flash("error","Failed to update. Try Again."),t.redirect("back")}});l.delete("/books/:id",O,async(e,t)=>{try{let o=await m.findById(e.params.id),s=await q.findById(e.user.id);await n.uploader.destroy(o.coverImg.cloudinary_id),await n.uploader.destroy(o.pdfBook.cloudinary_id),s.posts=s.posts.filter(a=>!a.equals(e.params.id)),await s.save(),await o.remove(),e.flash("success","Post deleted."),t.redirect("/books")}catch(o){e.flash("error","Failed to delete. Try Again."),t.redirect("/books")}});te.exports=l});var ae=i((ro,ie)=>{var re=require("express").Router(),Le=d(),{isLoggedIn:Re}=p();re.post("/books/:id/like",Re,async(e,t)=>{let o=await Le.findById(e.params.id);o.likedUsers.includes(e.body.userid)?(o.likedUsers=o.likedUsers.filter(s=>!s.equals(e.body.userid)),o.likes>0&&(o.likes=o.likes-1)):(o.likedUsers.push(e.body.userid),o.likes=o.likes+1),await o.save(),t.send({likes:o.likes})});ie.exports=re});var le=i((io,ce)=>{var b=require("express").Router(),ne=d(),I=C(),{isLoggedIn:je,isCommentOwner:E}=p();b.post("/books/:id/comments",je,async(e,t)=>{try{if(e.body.content){let o=await ne.findById(e.params.id),s=new I({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await s.save(),o.comments.push(s._id),await o.save()}t.redirect(`/books/${e.params.id}`)}catch(o){t.redirect(`/books/${e.params.id}`),console.log(o)}});b.get("/books/:book_id/comments/:comment_id/edit",E,async(e,t)=>{try{let o=await I.findById(e.params.comment_id);t.render("comments/edit",{pageTitle:"Edit comment",bookId:e.params.book_id,comment:o})}catch(o){console.log(o)}});b.put("/books/:book_id/comments/:comment_id",E,async(e,t)=>{try{let o=await I.findById(e.params.comment_id);e.body.content&&(o.content=e.body.content),await o.save(),t.redirect(`/books/${e.params.book_id}`)}catch(o){console.log(o)}});b.delete("/books/:book_id/comments/:comment_id",E,async(e,t)=>{try{let o=await I.findById(e.params.comment_id),s=await ne.findById(e.params.book_id);s.comments=s.comments.filter(a=>!a.equals(e.params.comment_id)),await s.save(),await o.remove(),t.redirect(`/books/${e.params.book_id}`)}catch(o){console.log(o)}});ce.exports=b});var pe=i((ao,de)=>{var v=require("express").Router(),Ae=g(),{isLoggedIn:ue}=p();v.get("/profile/:id",async(e,t)=>{try{let o=await Ae.findById(e.params.id).populate("posts").exec();t.render("profile/index",{pageTitle:o.fullName,userProfile:o})}catch(o){t.send({error:o})}});v.put("/profile/:id/edit",ue,async(e,t)=>{t.send("edit profile")});v.delete("/profile/:id",ue,async(e,t)=>{t.send("delete user account")});de.exports=v});var me=require("path"),S=require("express"),Pe=require("mongoose"),$e=require("method-override"),ge=require("express-session"),Me=require("connect-mongo")(ge),ye=require("passport"),x=require("dayjs"),Ye=require("dayjs/plugin/relativeTime");x.extend(Ye);var Fe=require("connect-flash");process.env.NODE_ENV!=="production"&&require("dotenv").config();N();R();var r=S();r.set("views",me.join("views"));r.set("view engine","ejs");r.use(S.static(me.join("public")));r.use(S.urlencoded({extended:!1}));r.use(S.json());r.use($e("_method"));r.use(ge({secret:process.env.COOKIE_SECRET_KEY,resave:!1,saveUninitialized:!1,store:new Me({mongooseConnection:Pe.connection,ttl:7*24*60*60})}));r.use(ye.initialize());r.use(ye.session());r.use(Fe());r.use((e,t,o)=>{t.locals.user=e.user,t.locals.errorMsg=e.flash("error"),t.locals.successMsg=e.flash("success"),t.locals.dateFormat=s=>x().to(x(s)),t.locals.smallDate=s=>x(new Date).format("MMM DD, YYYY"),t.locals.capitalize=s=>typeof s!="string"?"":s.charAt(0).toUpperCase()+s.slice(1),o()});r.use($());r.use(G());r.use(se());r.use(ae());r.use(le());r.use(pe());r.get("*",(e,t)=>{t.render("404",{pageTitle:"404"})});var fe=process.env.PORT||3e3;r.listen(fe,()=>console.log(`http://localhost:${fe}`));
