var i=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var p=i((De,O)=>{var b=require("mongoose"),$e=require("path"),ge=b.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImg:{url:{type:String},cloudinary_id:{type:String}},pdfBook:{url:{type:String},cloudinary_id:{type:String}},pageNo:{type:Number},language:{type:String},status:{type:String,default:"public",enum:["public","private"]},comments:[{type:b.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:b.Schema.Types.ObjectId,ref:"User"},likes:{type:Number,default:0}},{timestamps:!0});O.exports=b.model("Book",ge)});var E=i(()=>{var ye=require("mongoose"),fe=async()=>{try{await ye.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}),console.log("database connected!!")}catch(e){console.log(e)}};fe()});var m=i((Ye,P)=>{var x=require("mongoose"),he=require("passport-local-mongoose"),L=x.Schema({username:{type:String,maxlength:20,unique:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://image.flaticon.com/icons/svg/758/758669.svg"},posts:[{type:x.Schema.Types.ObjectId,ref:"Book"}]},{timestamps:!0});L.plugin(he);P.exports=x.model("User",L)});var A=i(()=>{var k=require("passport"),be=require("passport-local").Strategy,ke=require("passport-google-oauth20").Strategy,g=m();k.serializeUser(g.serializeUser());k.deserializeUser(g.deserializeUser());k.use(new be(g.authenticate()));k.use(new ke({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/cb"},async(e,t,o,s)=>{try{let n=await g.findOne({googleId:o.id});if(n)return s(null,n);let u=new g({username:o.displayName.toLowerCase().split(" ").join("_"),fullName:o.displayName,googleId:o.id,thumbnail:o.photos[0].value,email:o.emails[0].value});await u.save(),s(null,u)}catch(n){console.log(n)}}))});var B=i((Ke,j)=>{var R=require("mongoose"),we=R.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});j.exports=R.model("Comment",we)});var f=i(y=>{var _e=p(),Ie=B();y.isLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return o();e.flash("error","You are not logged in"),t.redirect("/login")};y.ifLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return t.redirect("/books");o()};y.isBookOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await _e.findById(e.params.id)).creator.equals(e.user._id))return o();e.flash("error","You can't edit other's post."),t.redirect(`/books/${e.params.id}`)};y.isCommentOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await Ie.findById(e.params.comment_id)).author===e.user.username)return o();e.flash("error","Permission denied"),t.redirect("back")}});var F=i((qe,D)=>{var c=require("express").Router(),w=require("passport"),$=m(),{ifLoggedIn:_}=f();c.get("/signup",_,(e,t)=>{t.render("auth/signup",{pageTitle:"Signup"})});c.post("/signup",_,async(e,t)=>{try{let o=await $.find({username:e.body.username}),s=e.body.username+Math.round(Math.random()*100).toString();if(o.length===1)throw e.flash("error",`${e.body.username} already taken. Try ${s}`),new Error("username already used.");let{username:n,password:u,email:ue,gender:de,age:pe,fullName:me}=e.body,S=new $({username:n,email:ue,gender:de,age:pe,fullName:me});await S.setPassword(u),await S.save(),w.authenticate("local")(e,t,()=>{e.flash("success",`Welcome to bookshelf, ${S.fullName}`),t.redirect("/books")})}catch(o){console.log(o),t.redirect("/signup")}});c.get("/login",_,(e,t)=>{t.render("auth/login",{pageTitle:"Login"})});c.post("/login",_,w.authenticate("local",{successRedirect:"/books",successMessage:"Successfully logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,t)=>{});c.get("/auth/google",w.authenticate("google",{scope:["profile","email"]}));c.get("/auth/google/cb",w.authenticate("google"),(e,t)=>{e.flash("success","Successfully logged in."),t.redirect("/books")});c.get("/logout",(e,t)=>{e.logOut(),e.flash("success","Successfully logged out."),t.redirect("/books")});D.exports=c});var z=i((He,Y)=>{var M=require("multer"),ve=require("path"),Se=M.diskStorage({destination:function(e,t,o){o(null,ve.join("public","uploads"))},filename:function(e,t,o){let s=t.originalname.split(" ").join("_");o(null,`${Date.now()}_${s}`)}}),xe=M({storage:Se,limits:1e8,fileFilter(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||o(new Error("File type not allowed.")),o(null,!0)}}),Be=xe.fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);Y.exports=Be});var W=i((Je,K)=>{var G=require("cloudinary").v2;G.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET,secure:!0});K.exports=G});var ee=i((Qe,Z)=>{var l=require("express").Router(),q=require("path"),H=require("fs-extra"),d=p(),Te=m(),{isLoggedIn:J,isBookOwner:T}=f(),Q=z(),a=W();l.get("/books",async(e,t)=>{try{let o=d.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(o=o.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(o=o.where("language").equals(e.query.language));let s=await o.find({status:"public"}).populate("creator").exec();t.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:s})}catch(o){t.render("error",{backButton:"/books",error:o})}});var V,X;l.post("/books",J,Q,async(e,t)=>{try{let o=await a.uploader.upload(e.files.coverImagePath[0].path,{public_id:`bookshelf/img/${e.files.coverImagePath[0].filename}`,eager:[{width:250,height:400,fetch_format:"auto"}]}),s=await a.uploader.upload(e.files.pdfFile[0].path,{public_id:`bookshelf/pdf/${e.files.pdfFile[0].filename}`});V=o.public_id,X=s.public_id,H.emptyDirSync(q.join("public","uploads"));let n=new d({title:e.body.title,author:e.body.author,description:e.body.description,pageNo:e.body.pageNo,language:e.body.language,status:e.body.status,creator:e.user._id,coverImg:{url:o.eager[0].secure_url,cloudinary_id:o.public_id},pdfBook:{url:s.secure_url,cloudinary_id:s.public_id}});await n.save();let u=await Te.findById(e.user._id);u.posts.push(n),await u.save(),e.flash("success","Post created."),t.redirect("/books")}catch(o){await a.uploader.destroy(V),await a.uploader.destroy(X),e.flash("error","Failed to create. Try Again"),t.redirect("/books")}});l.get("/books/new",J,(e,t)=>{t.render("books/new",{pageTitle:"Add Books",path:e.path})});l.get("/books/:id",async(e,t)=>{try{let o=await d.findById(e.params.id).populate("comments").populate("creator").exec();t.render("books/show",{pageTitle:o.title,book:o})}catch(o){console.log(o),t.redirect("/books")}});l.get("/books/:id/edit",T,async(e,t)=>{try{let o=await d.findById(e.params.id);t.render("books/edit",{pageTitle:o.title,book:o})}catch(o){console.log(o),t.redirect("/books")}});l.put("/books/:id",T,Q,async(e,t)=>{try{let o=await d.findById(e.params.id);if(e.body.title&&(o.title=e.body.title),e.body.author&&(o.author=e.body.author),e.body.description&&(o.description=e.body.description),e.body.pageNo&&(o.pageNo=e.body.pageNo),e.body.language&&(o.language=e.body.language),e.body.status&&(o.status=e.body.status),e.body.publishDate&&(o.publishDate=e.body.publishDate),e.files.coverImagePath){await a.uploader.destroy(o.coverImg.cloudinary_id);let s=await a.uploader.upload(e.files.coverImagePath[0].path,{public_id:`bookshelf/img/${e.files.coverImagePath[0].filename}`,eager:[{width:250,height:400,fetch_format:"auto"}]});o.coverImg={url:s.eager[0].secure_url,cloudinary_id:s.public_id}}if(e.files.pdfFile){await a.uploader.destroy(o.pdfBook.cloudinary_id);let s=await a.uploader.upload(e.files.pdfFile[0].path,{public_id:`bookshelf/pdf/${e.files.pdfFile[0].filename}`});o.pdfBook={url:s.secure_url,cloudinary_id:s.public_id}}H.emptyDirSync(q.join("public","uploads")),await o.save(),e.flash("success","Post updated."),t.redirect("/books/"+e.params.id)}catch(o){e.flash("error","Failed to update. Try Again."),t.redirect("back")}});l.delete("/books/:id",T,async(e,t)=>{try{let o=await d.findById(e.params.id);await a.uploader.destroy(o.coverImg.cloudinary_id),await a.uploader.destroy(o.pdfBook.cloudinary_id),await o.remove(),e.flash("success","Post deleted."),t.redirect("/books")}catch(o){e.flash("error","Failed to delete. Try Again."),t.redirect("/books")}});Z.exports=l});var te=i((Ve,oe)=>{var h=require("express").Router(),Ue=p(),I=B(),{isLoggedIn:Ne,isCommentOwner:U}=f();h.post("/books/:id/comments",Ne,async(e,t)=>{try{let o=await Ue.findById(e.params.id),s=new I({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await s.save(),o.comments.push(s),await o.save(),t.redirect(`/books/${e.params.id}`)}catch(o){t.redirect(`/books/${e.params.id}`),console.log(o)}});h.get("/books/:book_id/comments/:comment_id/edit",U,async(e,t)=>{let o=await I.findById(e.params.comment_id);t.render("comments/edit",{pageTitle:"Edit comments",bookId:e.params.book_id,comment:o})});h.put("/books/:book_id/comments/:comment_id",U,async(e,t)=>{let o=await I.findById(e.params.comment_id);e.body.content&&(o.content=e.body.content),await o.save(),t.redirect(`/books/${e.params.book_id}`)});h.delete("/books/:book_id/comments/:comment_id",U,async(e,t)=>{await(await I.findById(e.params.comment_id)).remove(),t.redirect(`/books/${e.params.book_id}`)});oe.exports=h});var ie=i((Xe,re)=>{var v=require("express").Router(),Ce=m(),{isLoggedIn:se}=f();v.get("/profile/:id",async(e,t)=>{try{let o=await Ce.findById(e.params.id).populate("posts").exec();t.render("profile/index",{pageTitle:o.fullName,userProfile:o})}catch(o){t.send({error:o})}});v.put("/profile/:id/edit",se,async(e,t)=>{t.send("edit profile")});v.delete("/profile/:id",se,async(e,t)=>{t.send("delete user account")});re.exports=v});var ae=require("path"),N=require("express"),Oe=require("mongoose"),Ee=require("method-override"),ne=require("express-session"),Le=require("connect-mongo")(ne),ce=require("passport"),C=require("dayjs"),Pe=require("dayjs/plugin/relativeTime");C.extend(Pe);var Ae=require("connect-flash");require("dotenv").config();var Re=p();E();A();var r=N();r.set("views",ae.join("views"));r.set("view engine","ejs");r.use(N.static(ae.join("public")));r.use(N.urlencoded({extended:!1}));r.use(Ee("_method"));r.use(ne({secret:process.env.COOKIE_SECRET_KEY,resave:!1,saveUninitialized:!1,store:new Le({mongooseConnection:Oe.connection,ttl:7*24*60*60})}));r.use(ce.initialize());r.use(ce.session());r.use(Ae());r.use((e,t,o)=>{t.locals.user=e.user,t.locals.errorMsg=e.flash("error"),t.locals.successMsg=e.flash("success"),t.locals.dateFormat=s=>C().to(C(s)),t.locals.capitalize=s=>typeof s!="string"?"":s.charAt(0).toUpperCase()+s.slice(1),o()});r.get("/",async(e,t)=>{try{let o=await Re.find().populate("creator").sort({publishDate:"desc"}).limit(10).exec();t.render("home",{pageTitle:"Paperback",books:o,path:e.path})}catch(o){t.render("404",{pageTitle:"404"})}});r.use(F());r.use(ee());r.use(te());r.use(ie());r.get("*",(e,t)=>{t.render("404",{pageTitle:"404"})});var le=process.env.PORT||3e3;r.listen(le,()=>console.log(`http://localhost:${le}`));
