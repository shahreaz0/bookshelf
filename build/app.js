var c=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var v=c((Re,$)=>{var I=require("mongoose"),R=require("path"),j=I.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImageName:{type:String,required:!0},pdfFileName:{type:String,required:!0},pageNo:{type:Number,min:1},language:{type:String},publishDate:{type:Date,default:new Date},status:{type:String,default:"public",enum:["public","private"]},comments:[{type:I.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:I.Schema.Types.ObjectId,ref:"User"}});j.virtual("coverImageUrl").get(function(){if(this.coverImageName)return"\\"+R.join("uploads","img","resized",this.coverImageName)});j.virtual("pdfFileUrl").get(function(){if(this.pdfFileName)return"\\"+R.join("uploads","pdf",this.pdfFileName)});$.exports=I.model("Book",j)});var h=c(($e,E)=>{var F=require("mongoose"),de=require("passport-local-mongoose"),D=F.Schema({username:{type:String,maxlength:20,unique:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://image.flaticon.com/icons/svg/758/758669.svg"},posts:[{type:F.Schema.Types.ObjectId,ref:"Book"}]},{timestamps:!0});D.plugin(de);E.exports=F.model("User",D)});var P=c((De,A)=>{var L=require("mongoose"),pe=L.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});A.exports=L.model("Comment",pe)});var b=c(y=>{var me=v(),ge=P();y.isLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return o();e.flash("error","You are not logged in"),t.redirect("/login")};y.ifLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return t.redirect("/books");o()};y.isBookOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await me.findById(e.params.id)).creator.equals(e.user._id))return o();e.flash("error","You can't edit other's post."),t.redirect(`/books/${e.params.id}`)};y.isCommentOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await ge.findById(e.params.comment_id)).author===e.user.username)return o();e.flash("error","Permission denied"),t.redirect("back")}});var q=c((Le,Y)=>{var M=require("multer"),G=require("path"),fe=M.diskStorage({destination:function(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?o(null,G.join("public","uploads","img")):t.originalname.match(/\.pdf$/i)&&o(null,G.join("public","uploads","pdf"))},filename:function(e,t,o){let s=t.originalname.split(" ").join("_");o(null,`${Date.now()}_${s}`)}}),he=M({storage:fe,limits:1e5,fileFilter(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||o(new Error("File type not allowed.")),o(null,!0)}}),ye=he.fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);Y.exports=ye});var Q=c((Ae,J)=>{var u=require("express").Router(),m=require("path"),d=require("fs"),K=require("sharp"),f=v(),be=h(),{isLoggedIn:W,isBookOwner:C}=b(),H=q();u.get("/books",async(e,t)=>{try{let o=f.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(o=o.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(o=o.where("language").equals(e.query.language));let s=await o.find({status:"public"}).populate("creator").exec();t.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:s})}catch(o){t.render("error",{backButton:"/books",error:o})}});u.post("/books",W,H,async(e,t)=>{try{d.access("./public/uploads/img/resized",U=>{U&&d.mkdirSync("./public/uploads/img/resized")});let o=e.files.coverImagePath[0].filename,s=`/uploads/img/resized/${o}`,a=e.files.pdfFile[0].filename,r=`/uploads/pdf/${a}`,n=e.files.coverImagePath[0].path;await K(n).resize(250,400).toFile(`./public${s}`);let g=new f({title:e.body.title,author:e.body.author,description:e.body.description,coverImageName:o,pdfFileName:a,pageNo:e.body.pageNo,language:e.body.language,status:e.body.status,creator:e.user._id});await g.save();let l=await be.findById(e.user._id);l.posts.push(g),await l.save(),e.flash("success","Post created."),t.redirect("/books")}catch(o){e.flash("error","Failed to create. Try Again"),t.redirect("/books")}});u.get("/books/new",W,(e,t)=>{t.render("books/new",{pageTitle:"Add Books",path:e.path})});u.get("/books/:id",async(e,t)=>{try{let o=await f.findById(e.params.id).populate("comments").populate("creator").exec();t.render("books/show",{pageTitle:o.title,book:o})}catch(o){console.log(o),t.redirect("/books")}});u.get("/books/:id/edit",C,async(e,t)=>{try{let o=await f.findById(e.params.id);t.render("books/edit",{pageTitle:o.title,book:o})}catch(o){console.log(o),t.redirect("/books")}});u.put("/books/:id",C,H,async(e,t)=>{try{let o=await f.findById(e.params.id);if(e.body.title&&(o.title=e.body.title),e.body.author&&(o.author=e.body.author),e.body.description&&(o.description=e.body.description),e.body.pageNo&&(o.pageNo=e.body.pageNo),e.body.language&&(o.language=e.body.language),e.body.status&&(o.status=e.body.status),e.body.publishDate&&(o.publishDate=e.body.publishDate),e.files.coverImagePath){let{filename:s}=e.files.coverImagePath[0],a=m.join("public","uploads","img",o.coverImageName);d.unlink(a,l=>{l&&console.log(l)});let r=m.join("public","uploads","img","resized",o.coverImageName);d.unlink(r,l=>{l&&console.log(l)});let n=e.files.coverImagePath[0].path,g=m.join("public","uploads","img","resized",s);await K(n).resize(250,400).toFile(g),o.coverImageName=s}if(e.files.pdfFile){let{filename:s}=e.files.pdfFile[0],a=m.join("public","uploads","pdf",o.pdfFileName);d.unlink(a,r=>{r&&console.log(r)}),o.pdfFileName=s}await o.save(),e.flash("success","Post updated."),t.redirect("/books/"+e.params.id)}catch(o){e.flash("error","Failed to update. Try Again."),t.redirect("back")}});u.delete("/books/:id",C,async(e,t)=>{try{let o=await f.findById(e.params.id),s=m.join("public","uploads","img",o.coverImageName),a=m.join("public","uploads","img","resized",o.coverImageName),r=m.join("public","uploads","pdf",o.pdfFileName);d.unlink(s,n=>console.log(n)),d.unlink(a,n=>console.log(n)),d.unlink(r,n=>console.log(n)),await o.remove(),e.flash("success","Post deleted."),t.redirect("/books")}catch(o){e.flash("error","Failed to delete. Try Again."),t.redirect("/books")}});J.exports=u});var Z=c((Me,X)=>{var p=require("express").Router(),S=require("passport"),V=h(),{ifLoggedIn:N}=b();p.get("/signup",N,(e,t)=>{t.render("auth/signup",{pageTitle:"Signup"})});p.post("/signup",N,async(e,t)=>{try{let o=await V.find({username:e.body.username}),s=e.body.username+Math.round(Math.random()*100).toString();if(o.length===1)throw e.flash("error",`${e.body.username} already taken. Try ${s}`),new Error("username already used.");let{username:a,password:r,email:n,gender:g,age:l,fullName:U}=e.body,_=new V({username:a,email:n,gender:g,age:l,fullName:U});await _.setPassword(r),await _.save(),S.authenticate("local")(e,t,()=>{e.flash("success",`Welcome to bookshelf, ${_.fullName}`),t.redirect("/books")})}catch(o){console.log(o),t.redirect("/signup")}});p.get("/login",N,(e,t)=>{t.render("auth/login",{pageTitle:"Login"})});p.post("/login",N,S.authenticate("local",{successRedirect:"/books",successMessage:"Successfully logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,t)=>{});p.get("/auth/google",S.authenticate("google",{scope:["profile","email"]}));p.get("/auth/google/cb",S.authenticate("google"),(e,t)=>{e.flash("success","Successfully logged in."),t.redirect("/books")});p.get("/logout",(e,t)=>{e.logOut(),e.flash("success","Successfully logged out."),t.redirect("/books")});X.exports=p});var oe=c((Ge,ee)=>{var k=require("express").Router(),ke=v(),x=P(),{isLoggedIn:we,isCommentOwner:O}=b();k.post("/books/:id/comments",we,async(e,t)=>{try{let o=await ke.findById(e.params.id),s=new x({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await s.save(),o.comments.push(s),await o.save(),t.redirect(`/books/${e.params.id}`)}catch(o){t.redirect(`/books/${e.params.id}`),console.log(o)}});k.get("/books/:book_id/comments/:comment_id/edit",O,async(e,t)=>{let o=await x.findById(e.params.comment_id);t.render("comments/edit",{pageTitle:"Edit comments",bookId:e.params.book_id,comment:o})});k.put("/books/:book_id/comments/:comment_id",O,async(e,t)=>{let o=await x.findById(e.params.comment_id);e.body.content&&(o.content=e.body.content),await o.save(),t.redirect(`/books/${e.params.book_id}`)});k.delete("/books/:book_id/comments/:comment_id",O,async(e,t)=>{await(await x.findById(e.params.comment_id)).remove(),t.redirect(`/books/${e.params.book_id}`)});ee.exports=k});var ie=c((Ye,se)=>{var B=require("express").Router(),Ie=h(),{isLoggedIn:te}=b();B.get("/profile/:id",async(e,t)=>{try{let o=await Ie.findById(e.params.id).populate("posts").exec();t.render("profile/index",{pageTitle:o.fullName,userProfile:o})}catch(o){console.log("profile.js line 13",o),t.send({error:o})}});B.put("/profile/:id/edit",te,async(e,t)=>{t.send("edit profile")});B.delete("/profile/:id",te,async(e,t)=>{t.send("delete user account")});se.exports=B});var ae=c(()=>{var ve=require("mongoose");require("dotenv").config();var Se=async()=>{try{await ve.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}),console.log("database connected!!")}catch(e){console.log(e)}};Se()});var re=c(()=>{var T=require("passport"),Ne=require("passport-local").Strategy,xe=require("passport-google-oauth20").Strategy,w=h();T.serializeUser(w.serializeUser());T.deserializeUser(w.deserializeUser());T.use(new Ne(w.authenticate()));T.use(new xe({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/cb"},async(e,t,o,s)=>{try{let a=await w.findOne({googleId:o.id});if(a)return s(null,a);let r=new w({username:o.displayName.toLowerCase().split(" ").join("_"),fullName:o.displayName,googleId:o.id,thumbnail:o.photos[0].value,email:o.emails[0].value});await r.save(),s(null,r)}catch(a){console.log(a)}}))});var ne=require("path"),z=require("express"),Be=require("mongoose"),Te=require("method-override"),ce=require("express-session"),Ue=require("connect-mongo")(ce),le=require("passport"),_e=require("date-fns/formatDistanceToNow"),je=require("connect-flash");require("dotenv").config();var Fe=Q(),Pe=Z(),Ce=oe(),Oe=ie();ae();re();var i=z();i.set("views",ne.join("views"));i.set("view engine","ejs");i.use(z.static(ne.join("public")));i.use(z.urlencoded({extended:!1}));i.use(Te("_method"));i.use(ce({secret:process.env.COOKIE_SECRET_KEY,resave:!1,saveUninitialized:!1,store:new Ue({mongooseConnection:Be.connection,ttl:7*24*60*60})}));i.use(le.initialize());i.use(le.session());i.use(je());i.use((e,t,o)=>{t.locals.user=e.user,t.locals.errorMsg=e.flash("error"),t.locals.successMsg=e.flash("success"),t.locals.dateFormat=s=>_e(s),t.locals.capitalize=s=>typeof s!="string"?"":s.charAt(0).toUpperCase()+s.slice(1),o()});i.get("/",(e,t)=>{t.render("home",{pageTitle:"Bookshelf",path:e.path})});i.use(Pe);i.use(Fe);i.use(Ce);i.use(Oe);i.get("*",(e,t)=>{t.render("404",{pageTitle:"404"})});var ue=process.env.PORT||3e3;i.listen(ue,()=>console.log(`http://localhost:${ue}`));
