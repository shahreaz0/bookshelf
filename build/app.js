var c=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var h=c((Ee,E)=>{var I=require("mongoose"),$=require("path"),j=I.Schema({title:{type:String,required:!0,trim:!0,maxlength:50},author:{type:String,required:!0,trim:!0,maxlength:30},description:{type:String,trim:!0},coverImageName:{type:String,required:!0},pdfFileName:{type:String,required:!0},pageNo:{type:Number,min:1},language:{type:String},status:{type:String,default:"public",enum:["public","private"]},comments:[{type:I.Schema.Types.ObjectId,ref:"Comment"}],creator:{type:I.Schema.Types.ObjectId,ref:"User"},likes:{type:Number,default:0}},{timestamps:!0});j.virtual("coverImageUrl").get(function(){if(this.coverImageName)return"\\"+$.join("uploads","img","resized",this.coverImageName)});j.virtual("pdfFileUrl").get(function(){if(this.pdfFileName)return"\\"+$.join("uploads","pdf",this.pdfFileName)});E.exports=I.model("Book",j)});var y=c((Le,D)=>{var P=require("mongoose"),pe=require("passport-local-mongoose"),L=P.Schema({username:{type:String,maxlength:20,unique:!0},password:{type:String,minlength:6},fullName:{type:String,maxlength:30},email:{type:String},gender:{type:String},age:{type:Number,min:1},googleId:{type:String},thumbnail:{type:String,default:"https://image.flaticon.com/icons/svg/758/758669.svg"},posts:[{type:P.Schema.Types.ObjectId,ref:"Book"}]},{timestamps:!0});L.plugin(pe);D.exports=P.model("User",L)});var F=c((De,M)=>{var A=require("mongoose"),me=A.Schema({content:{type:String,maxlength:100,trim:!0},author:{type:String},thumbnail:{type:String}},{timestamps:!0});M.exports=A.model("Comment",me)});var k=c(b=>{var ge=h(),fe=F();b.isLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return o();e.flash("error","You are not logged in"),t.redirect("/login")};b.ifLoggedIn=(e,t,o)=>{if(e.isAuthenticated())return t.redirect("/books");o()};b.isBookOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await ge.findById(e.params.id)).creator.equals(e.user._id))return o();e.flash("error","You can't edit other's post."),t.redirect(`/books/${e.params.id}`)};b.isCommentOwner=async(e,t,o)=>{if(!e.isAuthenticated())return e.flash("error","You are not logged in"),t.redirect("/login");if((await fe.findById(e.params.comment_id)).author===e.user.username)return o();e.flash("error","Permission denied"),t.redirect("back")}});var K=c((Me,q)=>{var G=require("multer"),Y=require("path"),he=G.diskStorage({destination:function(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp)$/i)?o(null,Y.join("public","uploads","img")):t.originalname.match(/\.pdf$/i)&&o(null,Y.join("public","uploads","pdf"))},filename:function(e,t,o){let s=t.originalname.split(" ").join("_");o(null,`${Date.now()}_${s}`)}}),ye=G({storage:he,limits:1e5,fileFilter(e,t,o){t.originalname.match(/\.(jpg|jpeg|png|webp|pdf)$/i)||o(new Error("File type not allowed.")),o(null,!0)}}),be=ye.fields([{name:"coverImagePath",maxCount:1},{name:"pdfFile",maxCount:1}]);q.exports=be});var V=c((Ge,Q)=>{var u=require("express").Router(),m=require("path"),d=require("fs"),W=require("sharp"),f=h(),ke=y(),{isLoggedIn:H,isBookOwner:C}=k(),J=K();u.get("/books",async(e,t)=>{try{let o=f.find();e.query.title&&(o=o.where("title").regex(new RegExp(e.query.title,"i"))),e.query.author&&(o=o.where("author").regex(new RegExp(e.query.author,"i"))),e.query.publishAfter&&(o=o.where("publishDate").gte(e.query.publishAfter)),e.query.publishBefore&&(o=o.where("publishDate").lte(e.query.publishBefore)),e.query.language&&(o=o.where("language").equals(e.query.language));let s=await o.find({status:"public"}).populate("creator").exec();t.render("books/index",{pageTitle:"Books",path:e.path,searchOptions:e.query,books:s})}catch(o){t.render("error",{backButton:"/books",error:o})}});u.post("/books",H,J,async(e,t)=>{try{d.access("./public/uploads/img/resized",U=>{U&&d.mkdirSync("./public/uploads/img/resized")});let o=e.files.coverImagePath[0].filename,s=`/uploads/img/resized/${o}`,r=e.files.pdfFile[0].filename,a=`/uploads/pdf/${r}`,n=e.files.coverImagePath[0].path;await W(n).resize(250,400).toFile(`./public${s}`);let g=new f({title:e.body.title,author:e.body.author,description:e.body.description,coverImageName:o,pdfFileName:r,pageNo:e.body.pageNo,language:e.body.language,status:e.body.status,creator:e.user._id});await g.save();let l=await ke.findById(e.user._id);l.posts.push(g),await l.save(),e.flash("success","Post created."),t.redirect("/books")}catch(o){e.flash("error","Failed to create. Try Again"),t.redirect("/books")}});u.get("/books/new",H,(e,t)=>{t.render("books/new",{pageTitle:"Add Books",path:e.path})});u.get("/books/:id",async(e,t)=>{try{let o=await f.findById(e.params.id).populate("comments").populate("creator").exec();t.render("books/show",{pageTitle:o.title,book:o})}catch(o){console.log(o),t.redirect("/books")}});u.get("/books/:id/edit",C,async(e,t)=>{try{let o=await f.findById(e.params.id);t.render("books/edit",{pageTitle:o.title,book:o})}catch(o){console.log(o),t.redirect("/books")}});u.put("/books/:id",C,J,async(e,t)=>{try{let o=await f.findById(e.params.id);if(e.body.title&&(o.title=e.body.title),e.body.author&&(o.author=e.body.author),e.body.description&&(o.description=e.body.description),e.body.pageNo&&(o.pageNo=e.body.pageNo),e.body.language&&(o.language=e.body.language),e.body.status&&(o.status=e.body.status),e.body.publishDate&&(o.publishDate=e.body.publishDate),e.files.coverImagePath){let{filename:s}=e.files.coverImagePath[0],r=m.join("public","uploads","img",o.coverImageName);d.unlink(r,l=>{l&&console.log(l)});let a=m.join("public","uploads","img","resized",o.coverImageName);d.unlink(a,l=>{l&&console.log(l)});let n=e.files.coverImagePath[0].path,g=m.join("public","uploads","img","resized",s);await W(n).resize(250,400).toFile(g),o.coverImageName=s}if(e.files.pdfFile){let{filename:s}=e.files.pdfFile[0],r=m.join("public","uploads","pdf",o.pdfFileName);d.unlink(r,a=>{a&&console.log(a)}),o.pdfFileName=s}await o.save(),e.flash("success","Post updated."),t.redirect("/books/"+e.params.id)}catch(o){e.flash("error","Failed to update. Try Again."),t.redirect("back")}});u.delete("/books/:id",C,async(e,t)=>{try{let o=await f.findById(e.params.id),s=m.join("public","uploads","img",o.coverImageName),r=m.join("public","uploads","img","resized",o.coverImageName),a=m.join("public","uploads","pdf",o.pdfFileName);d.unlink(s,n=>console.log(n)),d.unlink(r,n=>console.log(n)),d.unlink(a,n=>console.log(n)),await o.remove(),e.flash("success","Post deleted."),t.redirect("/books")}catch(o){e.flash("error","Failed to delete. Try Again."),t.redirect("/books")}});Q.exports=u});var ee=c((Ye,Z)=>{var p=require("express").Router(),S=require("passport"),X=y(),{ifLoggedIn:N}=k();p.get("/signup",N,(e,t)=>{t.render("auth/signup",{pageTitle:"Signup"})});p.post("/signup",N,async(e,t)=>{try{let o=await X.find({username:e.body.username}),s=e.body.username+Math.round(Math.random()*100).toString();if(o.length===1)throw e.flash("error",`${e.body.username} already taken. Try ${s}`),new Error("username already used.");let{username:r,password:a,email:n,gender:g,age:l,fullName:U}=e.body,_=new X({username:r,email:n,gender:g,age:l,fullName:U});await _.setPassword(a),await _.save(),S.authenticate("local")(e,t,()=>{e.flash("success",`Welcome to bookshelf, ${_.fullName}`),t.redirect("/books")})}catch(o){console.log(o),t.redirect("/signup")}});p.get("/login",N,(e,t)=>{t.render("auth/login",{pageTitle:"Login"})});p.post("/login",N,S.authenticate("local",{successRedirect:"/books",successMessage:"Successfully logged in.",failureRedirect:"/login",failureMessage:"Incorrect username or password."}),(e,t)=>{});p.get("/auth/google",S.authenticate("google",{scope:["profile","email"]}));p.get("/auth/google/cb",S.authenticate("google"),(e,t)=>{e.flash("success","Successfully logged in."),t.redirect("/books")});p.get("/logout",(e,t)=>{e.logOut(),e.flash("success","Successfully logged out."),t.redirect("/books")});Z.exports=p});var te=c((qe,oe)=>{var w=require("express").Router(),we=h(),x=F(),{isLoggedIn:ve,isCommentOwner:O}=k();w.post("/books/:id/comments",ve,async(e,t)=>{try{let o=await we.findById(e.params.id),s=new x({content:e.body.content,author:e.user.username,thumbnail:e.user.thumbnail});await s.save(),o.comments.push(s),await o.save(),t.redirect(`/books/${e.params.id}`)}catch(o){t.redirect(`/books/${e.params.id}`),console.log(o)}});w.get("/books/:book_id/comments/:comment_id/edit",O,async(e,t)=>{let o=await x.findById(e.params.comment_id);t.render("comments/edit",{pageTitle:"Edit comments",bookId:e.params.book_id,comment:o})});w.put("/books/:book_id/comments/:comment_id",O,async(e,t)=>{let o=await x.findById(e.params.comment_id);e.body.content&&(o.content=e.body.content),await o.save(),t.redirect(`/books/${e.params.book_id}`)});w.delete("/books/:book_id/comments/:comment_id",O,async(e,t)=>{await(await x.findById(e.params.comment_id)).remove(),t.redirect(`/books/${e.params.book_id}`)});oe.exports=w});var re=c((Ke,ie)=>{var B=require("express").Router(),Ie=y(),{isLoggedIn:se}=k();B.get("/profile/:id",async(e,t)=>{try{let o=await Ie.findById(e.params.id).populate("posts").exec();t.render("profile/index",{pageTitle:o.fullName,userProfile:o})}catch(o){t.send({error:o})}});B.put("/profile/:id/edit",se,async(e,t)=>{t.send("edit profile")});B.delete("/profile/:id",se,async(e,t)=>{t.send("delete user account")});ie.exports=B});var ae=c(()=>{var Se=require("mongoose");require("dotenv").config();var Ne=async()=>{try{await Se.connect(process.env.MONGO_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}),console.log("database connected!!")}catch(e){console.log(e)}};Ne()});var ne=c(()=>{var T=require("passport"),xe=require("passport-local").Strategy,Be=require("passport-google-oauth20").Strategy,v=y();T.serializeUser(v.serializeUser());T.deserializeUser(v.deserializeUser());T.use(new xe(v.authenticate()));T.use(new Be({clientID:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,callbackURL:"/auth/google/cb"},async(e,t,o,s)=>{try{let r=await v.findOne({googleId:o.id});if(r)return s(null,r);let a=new v({username:o.displayName.toLowerCase().split(" ").join("_"),fullName:o.displayName,googleId:o.id,thumbnail:o.photos[0].value,email:o.emails[0].value});await a.save(),s(null,a)}catch(r){console.log(r)}}))});var ce=require("path"),z=require("express"),Te=require("mongoose"),Ue=require("method-override"),le=require("express-session"),_e=require("connect-mongo")(le),ue=require("passport"),R=require("dayjs"),je=require("dayjs/plugin/relativeTime");R.extend(je);var Pe=require("connect-flash");require("dotenv").config();var Fe=V(),Ce=ee(),Oe=te(),ze=re(),Re=h();ae();ne();var i=z();i.set("views",ce.join("views"));i.set("view engine","ejs");i.use(z.static(ce.join("public")));i.use(z.urlencoded({extended:!1}));i.use(Ue("_method"));i.use(le({secret:process.env.COOKIE_SECRET_KEY,resave:!1,saveUninitialized:!1,store:new _e({mongooseConnection:Te.connection,ttl:7*24*60*60})}));i.use(ue.initialize());i.use(ue.session());i.use(Pe());i.use((e,t,o)=>{t.locals.user=e.user,t.locals.errorMsg=e.flash("error"),t.locals.successMsg=e.flash("success"),t.locals.dateFormat=s=>R().to(R(s)),t.locals.capitalize=s=>typeof s!="string"?"":s.charAt(0).toUpperCase()+s.slice(1),o()});i.get("/",async(e,t)=>{try{let o=await Re.find().populate("creator").sort({publishDate:"desc"}).limit(10).exec();t.render("home",{pageTitle:"Paperback",books:o,path:e.path})}catch(o){t.render("404",{pageTitle:"404"})}});i.use(Ce);i.use(Fe);i.use(Oe);i.use(ze);i.get("*",(e,t)=>{t.render("404",{pageTitle:"404"})});var de=process.env.PORT||3e3;i.listen(de,()=>console.log(`http://localhost:${de}`));
